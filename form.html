<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Survey Form - In Progress</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="form-page">
    <div class="container">
        <!-- Timer Header -->
        <div class="timer-header">
            <div class="timer-card">
                <div class="timer-main">
                    <div class="timer-value" id="timer">00:00</div>
                    <div class="timer-label">
                        <i class="fas fa-clock"></i>
                        Time Elapsed
                    </div>
                </div>
                <div class="session-info">
                    <div class="info-item">
                        <span class="info-label">Started</span>
                        <span class="info-value" id="startTime">--:--</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Session</span>
                        <span class="info-value" id="sessionId">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Indicator -->
        <div class="progress-indicator">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text">
                <i class="fas fa-info-circle"></i>
                Complete the form below and click submit
            </div>
        </div>

        <!-- Form Container -->
        <div class="form-wrapper">
            <div class="form-header">
                <h1><i class="fas fa-edit"></i> Survey Form</h1>
                <p>Please fill out all required fields. Your progress is being timed for research purposes.</p>
            </div>

            <!-- Google Form Iframe -->
            <div class="iframe-container">
                <div class="loading-overlay" id="loadingOverlay">
                    <div class="spinner"></div>
                    <p>Loading form...</p>
                </div>
                <iframe 
                    id="googleForm"
                    src="https://docs.google.com/forms/d/e/1FAIpQLSe98h8JuwgdzUlauVykobND66yGuOqiEEpyl913QP4NJ40DrA/viewform?embedded=true"
                    frameborder="0" 
                    marginheight="0" 
                    marginwidth="0"
                    allowfullscreen>
                    Loading...
                </iframe>
            </div>

            <!-- Manual Return Button (backup) -->
            <div class="manual-return" id="manualReturn" style="display: none;">
                <div class="return-card">
                    <h3><i class="fas fa-check-circle"></i> Form Submitted?</h3>
                    <p>If you've submitted the form and it's not redirecting automatically, click below:</p>
                    <button id="returnBtn" class="return-button">
                        <i class="fas fa-arrow-left"></i>
                        Return to Main Page
                    </button>
                </div>
            </div>
        </div>

        <!-- Exit Warning Modal -->
        <div class="exit-modal" id="exitModal">
            <div class="modal-content">
                <div class="warning-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h2>Leave Survey?</h2>
                <p>Your progress will be lost if you leave now. Are you sure?</p>
                <div class="modal-actions">
                    <button id="stayBtn" class="stay-button">Stay & Continue</button>
                    <button id="leaveBtn" class="leave-button">Leave Survey</button>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Form page specific JavaScript
        let startTime = null;
        let sessionId = null;
        let timerInterval = null;
        let seconds = 0;
        let formSubmitted = false;

        document.addEventListener('DOMContentLoaded', function() {
            initializeFormPage();
            setupEventListeners();
            startTimer();
            monitorFormSubmission();
            showManualReturnAfterDelay();
        });

        function initializeFormPage() {
            // Get start time and session from localStorage
            const storedStartTime = localStorage.getItem('surveyStartTime');
            const storedSessionId = localStorage.getItem('sessionId');
            const surveyActive = localStorage.getItem('surveyActive');

            if (!storedStartTime || !storedSessionId || surveyActive !== 'true') {
                // Redirect back if no active survey
                window.location.href = 'index.html';
                return;
            }

            startTime = new Date(storedStartTime);
            sessionId = storedSessionId;

            // Calculate elapsed time
            const now = new Date();
            seconds = Math.floor((now - startTime) / 1000);

            // Update display
            document.getElementById('startTime').textContent = startTime.toLocaleTimeString();
            document.getElementById('sessionId').textContent = sessionId.substr(-8);

            console.log('Form page initialized:', { sessionId, startTime, seconds });
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                if (!formSubmitted) {
                    seconds++;
                    updateTimerDisplay();
                    updateProgress();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            document.getElementById('timer').textContent = 
                `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function updateProgress() {
            // Simulate progress based on time (optional visual feedback)
            const maxTime = 600; // 10 minutes
            const progress = Math.min((seconds / maxTime) * 100, 100);
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function setupEventListeners() {
            // Handle iframe load
            const iframe = document.getElementById('googleForm');
            iframe.addEventListener('load', function() {
                setTimeout(() => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }, 1000);
            });

            // Manual return button
            document.getElementById('returnBtn').addEventListener('click', function() {
                handleFormCompletion();
            });

            // Exit warning modal
            document.getElementById('stayBtn').addEventListener('click', function() {
                document.getElementById('exitModal').classList.remove('show');
            });

            document.getElementById('leaveBtn').addEventListener('click', function() {
                localStorage.removeItem('surveyStartTime');
                localStorage.removeItem('sessionId');
                localStorage.removeItem('surveyActive');
                window.location.href = 'index.html';
            });

            // Prevent accidental exit
            window.addEventListener('beforeunload', function(e) {
                if (!formSubmitted && seconds > 10) {
                    e.preventDefault();
                    e.returnValue = 'Your survey progress will be lost. Are you sure you want to leave?';
                    return e.returnValue;
                }
            });

            // Handle back button with warning
            window.addEventListener('popstate', function(e) {
                if (!formSubmitted) {
                    e.preventDefault();
                    document.getElementById('exitModal').classList.add('show');
                    history.pushState(null, null, location.href);
                }
            });

            // Push initial state to handle back button
            history.pushState(null, null, location.href);
        }

        function monitorFormSubmission() {
            let checkCount = 0;
            const maxChecks = 1200; // 20 minutes maximum

            const checkInterval = setInterval(() => {
                checkCount++;

                if (formSubmitted || checkCount >= maxChecks) {
                    clearInterval(checkInterval);
                    return;
                }

                try {
                    const iframe = document.getElementById('googleForm');
                    if (iframe.contentDocument) {
                        const iframeDoc = iframe.contentDocument;
                        const bodyText = iframeDoc.body.innerText.toLowerCase();

                        if (bodyText.includes('your response has been recorded') ||
                            bodyText.includes('thank you') ||
                            bodyText.includes('submitted') ||
                            bodyText.includes('response recorded')) {
                            
                            handleFormCompletion();
                        }
                    }
                } catch (e) {
                    // Cross-origin restrictions - expected
                }
            }, 3000); // Check every 3 seconds
        }

        function showManualReturnAfterDelay() {
            // Show manual return option after 2 minutes
            setTimeout(() => {
                if (!formSubmitted) {
                    document.getElementById('manualReturn').style.display = 'block';
                }
            }, 120000); // 2 minutes
        }

        function handleFormCompletion() {
            if (formSubmitted) return;

            formSubmitted = true;
            clearInterval(timerInterval);

            const endTime = new Date();
            const totalSeconds = Math.floor((endTime - startTime) / 1000);
            const mins = Math.floor(totalSeconds / 60);
            const secs = totalSeconds % 60;
            const timeString = `${mins}m ${secs}s`;

            console.log('Form completed:', { sessionId, totalSeconds, timeString });

            // Record timing data to Google Sheets (you'll need to implement this)
            recordTimingData(sessionId, startTime, endTime, totalSeconds);

            // Return to main page with completion data
            const returnUrl = `index.html?completed=true&time=${encodeURIComponent(timeString)}&session=${encodeURIComponent(sessionId)}`;
            window.location.href = returnUrl;
        }

        function recordTimingData(sessionId, startTime, endTime, totalSeconds) {
            // This function would send timing data to Google Sheets
            // You can implement this using Google Apps Script Web App or Google Sheets API
            
            const timingData = {
                sessionId: sessionId,
                startTime: startTime.toISOString(),
                endTime: endTime.toISOString(),
                totalSeconds: totalSeconds,
                userAgent: navigator.userAgent,
                screenSize: `${screen.width}x${screen.height}`,
                timestamp: new Date().toISOString()
            };

            // Option 1: Send to Google Apps Script Web App
            const scriptUrl = 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL'; // Replace with your script URL
            
            fetch(scriptUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(timingData)
            }).then(() => {
                console.log('Timing data sent successfully');
            }).catch((error) => {
                console.error('Error sending timing data:', error);
                // Store locally as backup
                localStorage.setItem('timingData_' + sessionId, JSON.stringify(timingData));
            });

            // Option 2: Use Google Sheets API (requires API key)
            // Implementation would go here if you prefer direct API access
        }
    </script>
</body>
</html>
